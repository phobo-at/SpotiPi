# Alarm Reliability Hypotheses

| Hypothesis | Status | Evidence | Fix Idea |
| --- | --- | --- | --- |
| **H1** Wall-clock timers break on NTP/DST adjustments | ✅ Confirmed | `src/core/alarm_scheduler.py:99-158` uses `datetime.now(tz=LOCAL_TZ)` and `time.time()` to gate the execution window. A positive clock step shrinks `window_deadline`, letting the loop exit before `execute_alarm()` succeeds. | Replace scheduler waits with monotonic deadlines (`time.monotonic()`/`monotonic_ns`) and recompute target deadlines relative to UTC. |
| **H2** DST rollover mishandled | ⚠️ Likely | `src/core/scheduler.py:23-45` performs `now.replace(...); target += timedelta(days=1)` without handling ambiguous/non-existent times. Europe/Vienna forward shift (last Sunday in March) would skip 02:30 alarms; the fallback shift duplicates triggers. | Normalize alarms in UTC (`ZoneInfo("UTC")`), store next-fire timestamps, and apply `fold` handling or `ZoneInfo.fromutc()` conversions. Add DST regression tests. |
| **H3** Scheduler lacks persistence/misfire grace | ✅ Confirmed | `src/core/alarm_scheduler.py:90-161` recomputes from config each loop, but missed windows are dropped once `ALARM_TRIGGER_WINDOW_MINUTES` elapses. No persisted queue or catch-up after reboot. Deployment relies on in-process thread (`run.py:35-60`) without `Persistent=true` timers. | Introduce monotonic catch-up queue or offload to `systemd` timer with `Persistent=true`. Persist last scheduled UTC timestamp. |
| **H4** Long inactivity causes token/network drift | ⚠️ Plausible | Scheduler pre-warm calls `ensure_token_valid()` and `get_device_id()` (`src/core/alarm_scheduler.py:120-134`) but there is no network readiness check or retry/jitter loop; Spotify functions rely on best-effort cache (`src/api/spotify.py:890-1038`). Overnight Wi-Fi blips or device sleep can defeat a single attempt. | Add readiness probes (network + Spotify auth) and exponential backoff within the trigger window; log structured states for diagnosis. |
| **H5** Recent optimisations regressed service semantics | ✅ Confirmed | Deployment script restarts `spotipi.service` (`scripts/deploy_to_pi.sh:24-196`), yet the repo no longer ships `scripts/spotipi.service`. Alarms now depend solely on Flask’s thread, meaning prior systemd reliability optimisations were effectively removed. | Reintroduce hardened systemd units/timers (or document shift to monotonic scheduler) and ensure install scripts deploy them. |
